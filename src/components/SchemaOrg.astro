---
/**
 * Schema.org JSON-LD injector
 * - 完成済みの schema オブジェクト（または配列）をそのまま渡す
 * - undefined / 関数 / Date などが混ざっても落ちにくいように sanitize してから stringify
 */
interface Props {
  schema: unknown; // object | object[]
}

const { schema } = Astro.props;

function sanitizeForJsonLd(input: unknown): unknown {
  // JSON.stringify は undefined を落とすけど、Dateや関数などで意図しない結果もあるので軽く整形
  if (input instanceof Date) return input.toISOString();
  if (typeof input === 'function') return undefined;
  if (typeof input === 'bigint') return input.toString();
  if (Array.isArray(input)) return input.map(sanitizeForJsonLd);
  if (input && typeof input === 'object') {
    const out: Record<string, unknown> = {};
    for (const [k, v] of Object.entries(input as Record<string, unknown>)) {
      const sv = sanitizeForJsonLd(v);
      if (sv !== undefined) out[k] = sv;
    }
    return out;
  }
  return input;
}

const safe = sanitizeForJsonLd(schema);
const json = JSON.stringify(safe);
---

{json && <script type="application/ld+json" set:html={json} />}